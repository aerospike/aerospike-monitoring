name: Create tar.gz and zip artefacts of dashboars

on: 
  push:
    # branches: [master]
    # TODO this combination logic of branch + tag is not working.
    tags:
       - v*

permissions:
  id-token: write
  actions: write
  contents: write

jobs:         
    tar_zipping_job:
      runs-on: ubuntu-latest    
      steps:
        - uses: actions/checkout@v3
          with:
            fetch-depth: 0

        - uses: actions-ecosystem/action-get-latest-tag@v1
          id: get-latest-tag

        - name: Create zip or tar files
          run: |
            cd config/grafana
            echo "Tar & GZipping tar files"
            VERSION=${GITHUB_REF_NAME#v}
            tar cvf aerospike-grafana-dashboards-$VERSION.tar dashboards/*
            gzip aerospike-grafana-dashboards*
            # zip -r aerospike-grafana-dashboards-$VERSION.zip dashboards/*
            # ls -lrt *.zip 
            ls -lrt *.tar.gz
        - name: Upload Release Asset
          env:
            GH_TOKEN: ${{ github.token }}
            TAG_NAME: "${{ steps.get-latest-tag.outputs.tag }}"
          run: |
             # echo "tag_name $TAG_NAME"
             echo
             
             files=$(find config/grafana -type f -name "aerospike-grafana-dashboards*" -printf "$(realpath -s %p) ")
         
             for file in $files; do
               echo "uploading file === $file to release-tag $TAG_NAME"
               gh release upload "$TAG_NAME" "$file"
             done   

             echo
             echo "lising of files ... "
             echo